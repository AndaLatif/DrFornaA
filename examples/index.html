<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>DrForna Cotranscriptional Folding</title>

    <link rel="stylesheet" href="drforna.css" />
    <style>
      .forminput {
        float: left;
        margin-left: 20px;
        margin: 5px;
      }
      .form {
        display: table;
        padding: 10px;
        clear: both;
      }

      .svg-container {
        padding: 20px;
      }

      .text-container {
        font-family: monospace;
        font-size: 8pt;
        padding: 20px;
        margin: 0px;
        background-color: #eee;
        display: none;
        overflow: hidden;
        max-height: 200px;
        overflow: scroll;
      }

      .table-container {
        padding: 20px;
      }

      .collapseButton {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 10px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
      }

      .active, .collapsible:hover {
        background-color: #ccc;
      }
    </style>
  </head>
  <body>
    <div style="max-width: 800px; margin: auto;">
      <div class="form">
        Select example:</br>
        <div class="forminput"><input type="radio" name="fileinput" value="short" checked>short</div>
        <div class="forminput"><input type="radio" name="fileinput" value="growing">growing</div>
        <div class="forminput"><input type="radio" name="fileinput" value="result">result</div>
        <div class="forminput"><input type="radio" name="fileinput" value="result1">result1</div>
        <div class="forminput"><input type="radio" name="fileinput" value="result2">result2</div>
        <div class="forminput"><input type="radio" name="fileinput" value="tRNA">tRNA</div>
        <div class="forminput"><input type="radio" name="fileinput" value="bistable">bistable</div>
      </div>
      <div class="form">
        Or provide a file:</br>
        <div class="forminput"><input type="file" id="files" name="files" title="Enter an input file"></div>
      </div>
      <button class="collapseButton" id="collapseButton">Show Input</button>
      <pre id="textContainer" class="text-container" ></pre>
      <div id="visContainer" class="svg-container" ></div>
      <div id="tableContainer" class="table-container"></div>
    </div>

    <script src="https://unpkg.com/jquery@3.4.1"></script>
    <script src="https://unpkg.com/d3@3.5"></script>
    <script src="drforna.js"></script>

    <script type='text/javascript'>
      function createNewPlot(file) {
          let data = d3.dsv(' ').parse(file.target.result);
          let currentCTView = 'time-series'
          let width = 800;
          let height = 600;

          let currentLayout = drforna.cotranscriptionalTimeSeriesLayout();

          // calculate the maximum time point in the simulation
          let maxTime = Math.max(...data.slice(0,data.length-1).map(x => x.time))

          let showPlot = function(plotLayout) {
            //plotLayout.simulationTime(maxTime);

            d3.select('#visContainer')
            .selectAll('div')
            .remove();

            var svg = d3.select('#visContainer')
            .data([data])
            .call(plotLayout);

            plotLayout.updateCurrentTime(plotLayout.width() - plotLayout.margin().left
                                        - plotLayout.margin().right);
            currentLayout.updateDimensions();
          }

          let setLayoutSize = function(layout) {
              let container = $('#visContainer')
              let svgW = container.width();
              let svgH = container.height();
              console.log(svgW, svgH)

              currentLayout.width(svgW)
              .height(svgH)

              currentLayout.updateDimensions();
          }

          let printTimePointCallback = function(dataAtTimePoint) {
            console.log(dataAtTimePoint);
          }

          var tableChart = drforna.currentTimepointTable('#tableContainer')

          showPlot(currentLayout
                  .newTimePointCallback((d) => d3.select('#tableContainer')
                  .data([d])
                  .call(tableChart)));



          setLayoutSize()
          window.addEventListener('resize', setLayoutSize, false);
          console.log('loaded!')
      }

      /* Collapsible Input field */
      let coll = $("#collapseButton");
      for (let i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var content = this.nextElementSibling;
          if (content.style.display === "block") {
            content.style.display = "none";
          } else {
            content.style.display = "block";
          }
        });
      }

      /* add event listener to the buttons */
      $('#files').on('change', function(evt) {
        $('input[type=radio][name=fileinput]:checked').attr('checked', false)
        console.log("loading: " + evt.target.files[0].name)
        let files = evt.target.files
        for (let i = 0, f; f = files[i]; i++) {
            let reader = new FileReader()
            reader.onload = (val) => {
              $('#textContainer').text(val);
              createNewPlot(val);
            }
            reader.readAsText(f);
        }
      })
      .on('click', function(){ this.value = null; });

      $('input[type=radio][name=fileinput]').change(function() {
          $('#files').val('');
          console.log("loading: " + this.value)
          $.get('data/' + this.value, (result) => {
              let file = {target: {}}
              file.target.result = result;
              file.type = 'text/plain';
              $('#textContainer').text(result);
              createNewPlot(file);
          }, "text");
      });

      $("input[type=radio][name=fileinput]:checked").trigger('change');

    </script>
  </body>
</html>
